# Документация по базе данных

## Общая информация
База данных использует PostgreSQL и управляется с помощью Liquibase. Все миграции хранятся в директории `changelog/changes/`.

### Конфигурация
- Master changelog: `db.changelog-master.yaml`
- Формат миграций: SQL
- Конфигурация в: `application.yml`

## Структура базы данных

### Таблица users
Таблица для хранения информации о пользователях.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | BIGSERIAL | Уникальный идентификатор | PRIMARY KEY |
| user_name | VARCHAR(255) | Имя пользователя | NOT NULL |
| email | VARCHAR(255) | Email пользователя | NOT NULL, UNIQUE |
| created_at | TIMESTAMP | Дата создания записи | NOT NULL |
| updated_at | TIMESTAMP | Дата обновления записи | NOT NULL |

Индексы:
- `idx_users_email` (email) - для быстрого поиска по email

### Таблица subscriptions
Таблица для хранения информации о подписках пользователей.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | BIGSERIAL | Уникальный идентификатор | PRIMARY KEY |
| service_name | VARCHAR(255) | Название сервиса | NOT NULL |
| start_date | TIMESTAMP | Дата начала подписки | NOT NULL |
| end_date | TIMESTAMP | Дата окончания подписки | NOT NULL |
| user_id | BIGINT | ID пользователя | NOT NULL, FOREIGN KEY |

Индексы:
- `idx_subscriptions_user_id` (user_id) - для быстрого поиска подписок пользователя
- `idx_subscriptions_start_date` (start_date) - для фильтрации по дате начала
- `idx_subscriptions_end_date` (end_date) - для фильтрации по дате окончания
- `idx_subscriptions_service_name` (service_name) - для поиска по названию сервиса

## Миграции

### V1: Создание таблиц
Файл: `01-create-tables.sql`
- Создание таблицы users
- Создание таблицы subscriptions
- Создание всех необходимых индексов
- Настройка внешних ключей

### V2: Тестовые данные
Файл: `02-insert-test-data.sql`
- Добавление тестовых пользователей:
  - Иван Петров (ivan@example.com)
  - Анна Смирнова (anna@example.com)
  - Алексей Иванов (alexey@example.com)
- Добавление тестовых подписок для каждого пользователя

## Управление миграциями

### Запуск миграций
Миграции запускаются автоматически при старте приложения. Для ручного запуска:

```bash
./gradlew liquibaseUpdate
```

### Откат миграций
Для отката последней миграции:
```bash
./gradlew liquibaseRollback
```

### Проверка статуса
Для проверки статуса миграций:
```bash
./gradlew liquibaseStatus
```

## Поддерживаемые сервисы
- Netflix
- YouTube Premium
- VK Музыка
- Яндекс.Плюс
- Spotify
- Apple Music
- Disney+
- HBO Max

## Рекомендации по работе с БД

### Индексы
- Все внешние ключи индексируются автоматически
- Дополнительные индексы созданы для часто используемых полей поиска
- При добавлении новых индексов учитывайте баланс между скоростью чтения и записи

### Ограничения
- Email пользователя должен быть уникальным
- Даты начала и окончания подписки не могут быть null
- При удалении пользователя все его подписки удаляются (CASCADE)

### Производительность
- Используйте составные индексы для сложных запросов
- Регулярно проводите VACUUM для оптимизации
- Мониторьте размер таблиц и индексов

## Мониторинг

### Статистика
- Получение ТОП-3 популярных подписок через эндпоинт `GET /subscriptions/top`
  - Возвращает список сервисов с количеством подписчиков
  - Сортировка по убыванию количества подписчиков
  - Ограничение на 3 записи

### Логирование
- Все операции с базой данных логируются
- Уровни логирования:
  - `root`: INFO
  - `com.subscriptionservice`: DEBUG
  - `org.springframework.web`: INFO
  - `org.hibernate.SQL`: DEBUG
  - `org.hibernate.type.descriptor.sql.BasicBinder`: TRACE
- Формат логов:
  - Консоль: `%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n`
  - Файл: `%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n`
- Логи сохраняются в файл `logs/application.log` с ротацией (максимум 7 файлов по 10MB) 